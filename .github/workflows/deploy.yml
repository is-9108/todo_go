# ラズパイへのデプロイ（Self-hosted Runner 使用）
# ラズパイ上で Runner を登録し、push または手動実行でデプロイ
#
# セットアップ: ラズパイに Self-hosted Runner を登録（README 参照）
# GitHub Secrets（任意・推奨）:
#   CORS_ORIGINS  例: http://192.168.1.100:3000,http://10.0.0.5:3000
#   NEXT_PUBLIC_API_URL  例: http://192.168.1.100:8080

name: Deploy to Raspberry Pi

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - ".gitignore"

jobs:
  deploy:
    name: Deploy on Pi
    runs-on: [self-hosted, Linux]  # ラズパイに登録した Runner

    steps:
      - uses: actions/checkout@v4

      - name: Create .env
        run: |
          {
            [ -n "${{ secrets.CORS_ORIGINS }}" ] && echo "CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}"
            [ -n "${{ secrets.NEXT_PUBLIC_API_URL }}" ] && echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}"
          } > .env
          [ -s .env ] && cat .env || echo "（Secrets 未設定・docker-compose のデフォルト値を使用）"

      - name: Build and deploy
        run: |
          docker compose -f docker-compose.prod.yml build
          docker compose -f docker-compose.prod.yml up -d
