# ラズパイへのデプロイ（テンプレート）
# 手動実行: Actions タブ → Deploy to Raspberry Pi → Run workflow
#
# 有効化するには GitHub Secrets に以下を設定:
#   DEPLOY_HOST, DEPLOY_USER, DEPLOY_KEY（SSH接続用）
#   CORS_ORIGINS（推奨）例: http://192.168.1.100:3000,http://10.0.0.5:3000
#   NEXT_PUBLIC_API_URL（オプション）ビルド時のフォールバック用

name: Deploy to Raspberry Pi

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Raspberry Pi
        uses: appleboy/ssh-action@v1.0.3
        env:
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          envs: CORS_ORIGINS,NEXT_PUBLIC_API_URL
          script: |
            cd /home/pi/kakeibo-app  # ラズパイ上のプロジェクトパスに変更
            git pull origin main
            # .env を生成（Secrets があれば使用、なければ既存 .env を維持）
            if [ -n "$CORS_ORIGINS" ] || [ -n "$NEXT_PUBLIC_API_URL" ]; then
              {
                [ -n "$CORS_ORIGINS" ] && echo "CORS_ORIGINS=$CORS_ORIGINS"
                [ -n "$NEXT_PUBLIC_API_URL" ] && echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL"
              } > .env
            fi
            docker compose -f docker-compose.prod.yml build
            docker compose -f docker-compose.prod.yml up -d
